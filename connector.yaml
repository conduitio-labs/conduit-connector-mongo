version: "1.0"
specification:
  name: mongo
  summary: The MongoDB source and destination plugin for Conduit, written in Go.
  description: "## Source\n\nThe MongoDB Source Connector connects to a MongoDB with the provided `uri`, `db`\nand `collection` and starts creating records for each change detected in a\ncollection.\n\nUpon starting, the Source takes a snapshot of a given collection in the\ndatabase, then switches into CDC mode. In CDC mode, the plugin reads events from\na [Change Stream](https://www.mongodb.com/docs/manual/changeStreams/). In order\nfor this to work correctly, your MongoDB instance must\nmeet [the criteria](https://www.mongodb.com/docs/manual/changeStreams/#availability)\nspecified on the official website.\n\n### Snapshot Capture\n\nWhen the connector first starts, snapshot mode is enabled. The connector reads\nall rows of a collection in batches using\na [cursor-based](https://www.mongodb.com/docs/drivers/go/current/fundamentals/crud/read-operations/cursor/)\npagination,\nlimiting the rows by `batchSize`. The connector stores the last processed\nelement value of an `orderingColumn` in a position, so the snapshot process can\nbe paused and resumed without losing data. Once all rows in that initial\nsnapshot are read the connector switches into CDC mode.\n\nThis behavior is enabled by default, but can be turned off by adding\n`\"snapshot\": false` to the Source configuration.\n\n### Change Data Capture\n\nThe connector implements CDC features for MongoDB by using a Change Stream that\nlistens to changes in the configured collection. Every detected change is\nconverted into a record and returned in the call to `Read`. If there is no\navailable record when `Read` is called, the connector returns\n`sdk.ErrBackoffRetry` error.\n\nThe connector stores a `resumeToken` of every Change Stream event in a position,\nso the CDC process is resumble.\n\n> **Warning**\n>\n> [Azure CosmosDB for MongoDB](https://learn.microsoft.com/en-us/azure/cosmos-db/mongodb/change-streams)\n> has very limited support for Change Streams, so they cannot be used for CDC.\n> If CDC is not possible, like in the case with CosmosDB, the connector only\n> supports detecting insert operations by polling for new documents.\n\n### Key handling\n\nThe connector always uses the `_id` field as a key.\n\nIf the `_id` field is `bson.ObjectID` the connector converts it to a string when\ntransferring a record to a destination, otherwise, it leaves it unchanged.\n\n## Destination\n\nThe MongoDB Destination takes a `opencdc.Record` and parses it into a valid\nMongoDB query. The Destination is designed to handle different payloads and\nkeys. Because of this, each record is individually parsed and written.\n\n### Collection name\n  \nIf a record contains an `opencdc.collection` property in its metadata it will be\nwritten in that collection, otherwise it will fall back to use the `collection`\nconfigured in the connector. Thus, a Destination can support multiple\ncollections in the same connector, as long as the user has proper access to\nthose collections.\n\n### Key handling\n\nThe connector uses all keys from an `opencdc.Record` when updating and deleting\ndocuments.\n\nIf the `_id` field can be converted to a `bson.ObjectID`, the connector converts\nit, otherwise, it uses it as it is."
  version: (devel)
  author: Meroxa, Inc.
  source:
    parameters:
      - name: collection
        description: |-
          Collection is the name of a collection the connector must
          write to (destination) or read from (source).
        type: string
        default: ""
        validations:
          - type: required
            value: ""
      - name: db
        description: DB is the name of a database the connector must work with.
        type: string
        default: ""
        validations:
          - type: required
            value: ""
      - name: auth.auth.awsSessionToken
        description: AWSSessionToken is an AWS session token.
        type: string
        default: ""
        validations: []
      - name: auth.auth.db
        description: |-
          DB is the name of a database that contains
          the user's authentication data.
        type: string
        default: ""
        validations: []
      - name: auth.auth.mechanism
        description: Mechanism is the authentication mechanism.
        type: string
        default: ""
        validations: []
      - name: auth.auth.password
        description: Password is the user's password.
        type: string
        default: ""
        validations: []
      - name: auth.auth.tls.caFile,omitempty
        description: |-
          TLSCAFile is the path to either a single or a bundle of
          certificate authorities to trust when making a TLS connection.
        type: string
        default: ""
        validations: []
      - name: auth.auth.tls.certificateKeyFile,omitempty
        description: |-
          TLSCertificateKeyFile is the path to the client certificate
          file or the client private key file.
        type: string
        default: ""
        validations: []
      - name: auth.auth.username
        description: Username is the username.
        type: string
        default: ""
        validations: []
      - name: batchSize
        description: BatchSize is the size of a document batch.
        type: int
        default: "1000"
        validations:
          - type: greater-than
            value: "0"
          - type: less-than
            value: "100000"
      - name: orderingField
        description: |-
          OrderingField is the name of a field that is used for ordering
          collection documents when capturing a snapshot.
        type: string
        default: _id
        validations: []
      - name: snapshot
        description: |-
          Snapshot determines whether the connector will take a snapshot
          of the entire collection before starting CDC mode.
        type: bool
        default: "true"
        validations: []
      - name: uri
        description: |-
          URI is the connection string.
          The URI can contain host names, IPv4/IPv6 literals, or an SRV record.
        type: string
        default: mongodb://localhost:27017
        validations: []
      - name: sdk.batch.delay
        description: Maximum delay before an incomplete batch is read from the source.
        type: duration
        default: "0"
        validations: []
      - name: sdk.batch.size
        description: Maximum size of batch before it gets read from the source.
        type: int
        default: "0"
        validations:
          - type: greater-than
            value: "-1"
      - name: sdk.schema.context.enabled
        description: |-
          Specifies whether to use a schema context name. If set to false, no schema context name will
          be used, and schemas will be saved with the subject name specified in the connector
          (not safe because of name conflicts).
        type: bool
        default: "true"
        validations: []
      - name: sdk.schema.context.name
        description: |-
          Schema context name to be used. Used as a prefix for all schema subject names.
          If empty, defaults to the connector ID.
        type: string
        default: ""
        validations: []
      - name: sdk.schema.extract.key.enabled
        description: Whether to extract and encode the record key with a schema.
        type: bool
        default: "true"
        validations: []
      - name: sdk.schema.extract.key.subject
        description: |-
          The subject of the key schema. If the record metadata contains the field
          "opencdc.collection" it is prepended to the subject name and separated
          with a dot.
        type: string
        default: key
        validations: []
      - name: sdk.schema.extract.payload.enabled
        description: Whether to extract and encode the record payload with a schema.
        type: bool
        default: "true"
        validations: []
      - name: sdk.schema.extract.payload.subject
        description: |-
          The subject of the payload schema. If the record metadata contains the
          field "opencdc.collection" it is prepended to the subject name and
          separated with a dot.
        type: string
        default: payload
        validations: []
      - name: sdk.schema.extract.type
        description: The type of the payload schema.
        type: string
        default: avro
        validations:
          - type: inclusion
            value: avro
  destination:
    parameters:
      - name: collection
        description: |-
          Collection is the name of a collection the connector must
          write to (destination) or read from (source).
        type: string
        default: ""
        validations:
          - type: required
            value: ""
      - name: db
        description: DB is the name of a database the connector must work with.
        type: string
        default: ""
        validations:
          - type: required
            value: ""
      - name: auth.auth.awsSessionToken
        description: AWSSessionToken is an AWS session token.
        type: string
        default: ""
        validations: []
      - name: auth.auth.db
        description: |-
          DB is the name of a database that contains
          the user's authentication data.
        type: string
        default: ""
        validations: []
      - name: auth.auth.mechanism
        description: Mechanism is the authentication mechanism.
        type: string
        default: ""
        validations: []
      - name: auth.auth.password
        description: Password is the user's password.
        type: string
        default: ""
        validations: []
      - name: auth.auth.tls.caFile,omitempty
        description: |-
          TLSCAFile is the path to either a single or a bundle of
          certificate authorities to trust when making a TLS connection.
        type: string
        default: ""
        validations: []
      - name: auth.auth.tls.certificateKeyFile,omitempty
        description: |-
          TLSCertificateKeyFile is the path to the client certificate
          file or the client private key file.
        type: string
        default: ""
        validations: []
      - name: auth.auth.username
        description: Username is the username.
        type: string
        default: ""
        validations: []
      - name: uri
        description: |-
          URI is the connection string.
          The URI can contain host names, IPv4/IPv6 literals, or an SRV record.
        type: string
        default: mongodb://localhost:27017
        validations: []
      - name: sdk.batch.delay
        description: Maximum delay before an incomplete batch is written to the destination.
        type: duration
        default: "0"
        validations: []
      - name: sdk.batch.size
        description: Maximum size of batch before it gets written to the destination.
        type: int
        default: "0"
        validations:
          - type: greater-than
            value: "-1"
      - name: sdk.rate.burst
        description: |-
          Allow bursts of at most X records (0 or less means that bursts are not
          limited). Only takes effect if a rate limit per second is set. Note that
          if `sdk.batch.size` is bigger than `sdk.rate.burst`, the effective batch
          size will be equal to `sdk.rate.burst`.
        type: int
        default: "0"
        validations:
          - type: greater-than
            value: "-1"
      - name: sdk.rate.perSecond
        description: Maximum number of records written per second (0 means no rate limit).
        type: float
        default: "0"
        validations:
          - type: greater-than
            value: "-1"
      - name: sdk.record.format
        description: |-
          The format of the output record. See the Conduit documentation for a full
          list of supported formats (https://conduit.io/docs/using/connectors/configuration-parameters/output-format).
        type: string
        default: opencdc/json
        validations: []
      - name: sdk.record.format.options
        description: |-
          Options to configure the chosen output record format. Options are normally
          key=value pairs separated with comma (e.g. opt1=val2,opt2=val2), except
          for the `template` record format, where options are a Go template.
        type: string
        default: ""
        validations: []
      - name: sdk.schema.extract.key.enabled
        description: Whether to extract and decode the record key with a schema.
        type: bool
        default: "true"
        validations: []
      - name: sdk.schema.extract.payload.enabled
        description: Whether to extract and decode the record payload with a schema.
        type: bool
        default: "true"
        validations: []
